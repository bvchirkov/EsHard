# EsHard
Прошивка для плат СУЭ-П1 на базе ATmega128rfa1.

На физическом уровне устройства соединены по интерфесу RS485. С помощью преобразователя RS485 to TTL осуществляется подключение к интерфесу UART. Скорость UART выставлена на уровне 9600.
<hr>

## Компиляция
``` 
make all ST=ARW SA=3
```
`ST - тип устройства`

Возможнные варианты:
  1. `ARW (0x01)` - световой указатель направления (стрелка)
  2. `BTN (0x02)` - ручной пожарный извещатель (кнопка)
  3. `LHT (0x03)` - световой сигнализатор разрешения использования проема (светофор)

`SA - адрес устройства`
 
Минимальное значение для адреса - 1, максимальное 127.

## Прошивка
Программатор `usbasp`
```
make flush
```
<hr>

## Протокол обращения

Каждое устройство на линии ждет/отправляет 3 байта - пакет.

**Входящий пакет** [от центрального узла (ПК)]

1-й байт - адрес устройства (`1 - 127` - индивидуальный, `128` - ширововещательный).

2-й байт - тип команды (`SET (0x01)` - отправка команды, `STATUS (0x00)` - запрос состояния устройства).

3-й байт - данные команды:
- `CMD_OFF (0x00)` - отключить устройство
- `CMD_LEFT (0x01)` - включить стрелку влево
- `CMD_RIGHT (0x02)` - включить стрелку вправо
- `CMD_STOP (0x01)` - включить светофор в режиме стоп (запрет движения через проем)
- `CMD_GO (0x02)` - включить светофор в режиме идти (разрешение движения через проем)

В качестве широковещательной команды может быть только `CMD_OFF (0x00)`

*Пример пакета для включения стрелки с адресом 1 вправо:*
```
0x01 0x01 0x02
```

**Исходящий пакет**

Первые два байта возвращаются в том же виде, что и пришли. Полезная нагрузка в третьем байте. Он выполняет роль шины данных:

7 бит - устанавливается, если команда получена верно.

6 бит - для стрелки и светофора бит блокировки. Блокировка используется, чтобы избавиться от выбора режима на каждом тике.
 
5 бит - для стрелки и светофора бит состояния - вкл/выкл во время мигания.

4 бит - устанавливается, если нажата кнопка.

3 бит - устанавливается, если произведена запись пришедшей команды в энергонезависимую память.

2 бит - не задйествован

1 и 0 бит - команда


*Пример исходящего пакета, который сообщает, что устройство с адресом 1 исполняет команду `0x02`, записало эту информацию в энергонезависимую память и сейчас включено:*
```
00000001 00000001 11101010
```

